xmlDocPtr xsltGetProfileInformation(xsltTransformContextPtr ctxt) { xmlDocPtr ret = NULL; xmlNodePtr root, child; char buf[100]; xsltStylesheetPtr style; xsltTemplatePtr *templates; xsltTemplatePtr templ; int nb = 0, max = 0, i, j; if (!ctxt) return NULL; if (!ctxt->profile) return NULL; nb = 0; max = 10000; templates = (xsltTemplatePtr *) xmlMalloc(max * sizeof(xsltTemplatePtr)); if (templates == NULL) return NULL; style = ctxt->style; while (style != NULL) { templ = style->templates; while (templ != NULL) { if (nb >= max) break; if (templ->nbCalls > 0) templates[nb++] = templ; templ = templ->next; } style = (xsltStylesheetPtr) xsltNextImport(style); } for (i = 0; i < nb - 1; i++) { for (j = i + 1; j < nb; j++) { if ((templates[i]->time <= templates[j]->time) || ((templates[i]->time == templates[j]->time) && (templates[i]->nbCalls <= templates[j]->nbCalls))) { templ = templates[j]; templates[j] = templates[i]; templates[i] = templ; } } } ret = xmlNewDoc(BAD_CAST "1.0"); root = xmlNewDocNode(ret, NULL, BAD_CAST "profile", NULL); xmlDocSetRootElement(ret, root); for (i = 0; i < nb; i++) { child = xmlNewChild(root, NULL, BAD_CAST "template", NULL); snprintf(buf, sizeof(buf), "%d", i + 1); xmlSetProp(child, BAD_CAST "rank", BAD_CAST buf); xmlSetProp(child, BAD_CAST "match", BAD_CAST templates[i]->match); xmlSetProp(child, BAD_CAST "name", BAD_CAST templates[i]->name); xmlSetProp(child, BAD_CAST "mode", BAD_CAST templates[i]->mode); snprintf(buf, sizeof(buf), "%d", templates[i]->nbCalls); xmlSetProp(child, BAD_CAST "calls", BAD_CAST buf); snprintf(buf, sizeof(buf), "%ld", templates[i]->time); xmlSetProp(child, BAD_CAST "time", BAD_CAST buf); snprintf(buf, sizeof(buf), "%ld", templates[i]->time / templates[i]->nbCalls); xmlSetProp(child, BAD_CAST "average", BAD_CAST buf); }; xmlFree(templates); return ret; }