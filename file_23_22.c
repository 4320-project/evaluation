zip_uint8_t * _zip_read_data(zip_buffer_t *buffer, zip_source_t *src, size_t length, bool nulp, zip_error_t *error) { zip_uint8_t *r; if (length == 0 && !nulp) { return NULL; } r = (zip_uint8_t *)malloc(length + (nulp ? 1 : 0)); if (!r) { zip_error_set(error, ZIP_ER_MEMORY, 0); return NULL; } if (buffer) { zip_uint8_t *data = _zip_buffer_get(buffer, length); if (data == NULL) { zip_error_set(error, ZIP_ER_MEMORY, 0); free(r); return NULL; } memcpy(r, data, length); } else { if (_zip_read(src, r, length, error) < 0) { free(r); return NULL; } } if (nulp) { zip_uint8_t *o; r[length] = 0; for (o = r; o < r + length; o++) if (*o == '\0') *o = ' '; } return r; }