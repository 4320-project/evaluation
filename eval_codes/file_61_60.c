sys_unlink(void) { struct inode *ip, *dp; struct dirent de; char name[DIRSIZ], *path; uint off; if(argstr(0, &path) < 0) return -1; if((dp = nameiparent(path, name)) == 0) return -1; ilock(dp); if(namecmp(name, ".") == 0 || namecmp(name, "..") == 0){ iunlockput(dp); return -1; } if((ip = dirlookup(dp, name, &off)) == 0){ iunlockput(dp); return -1; } ilock(ip); if(ip->nlink < 1) panic("unlink: nlink < 1"); if(ip->type == T_DIR && !isdirempty(ip)){ iunlockput(ip); iunlockput(dp); return -1; } memset(&de, 0, sizeof(de)); if(writei(dp, (char*)&de, off, sizeof(de)) != sizeof(de)) panic("unlink: writei"); iunlockput(dp); ip->nlink--; iupdate(ip); iunlockput(ip); return 0; }